name: Deploy Math4Child to Netlify

on:
  push:
    branches: [ main ]
    paths: [ 'apps/math4child/**' ]
  pull_request:
    branches: [ main ]
    paths: [ 'apps/math4child/**' ]
  workflow_dispatch:

jobs:
  deploy:
    name: ğŸŒ Deploy to math4child.com
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
          cache-dependency-path: 'apps/math4child/package-lock.json'
          
      - name: ğŸ“¦ Install Dependencies
        run: |
          cd apps/math4child
          npm ci
          
      - name: ğŸ” Lint Code
        run: |
          cd apps/math4child
          npm run lint || echo "Lint completed with warnings"
          
      - name: ğŸ—ï¸ Build Application
        run: |
          cd apps/math4child
          npm run build
        env:
          NEXT_PUBLIC_APP_URL: https://math4child.com
          
      - name: ğŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: math4child-netlify-build
          path: |
            apps/math4child/.next
            apps/math4child/out
          retention-days: 7
          if-no-files-found: ignore
          
      - name: ğŸš€ Deploy to Netlify
        if: github.ref == 'refs/heads/main'
        uses: nwtgck/actions-netlify@v3.0
        with:
          publish-dir: 'apps/math4child/.next'
          production-branch: main
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "ğŸš€ Deploy Math4Child v2.0.0 from GitHub Actions"
          enable-pull-request-comment: true
          enable-commit-comment: true
          overwrites-pull-request-comment: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
          
      - name: ğŸ‰ Deployment Success
        if: github.ref == 'refs/heads/main'
        run: |
          echo "ğŸ‰ Math4Child deployed successfully to Netlify!"
          echo "ğŸŒ Live URL: https://math4child.com"
          echo "ğŸ“± Mobile optimized and ready!"

  lighthouse:
    name: ğŸ” Lighthouse Performance
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v4
      - name: ğŸ” Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            https://math4child.com
          uploadArtifacts: true
          temporaryPublicStorage: true

name: Math4Child CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 6 * * *'

env:
  NODE_VERSION: 18
  NEXT_PUBLIC_APP_NAME: Math4Child
  NEXT_PUBLIC_DOMAIN: www.math4child.com

jobs:
  # ===================================================================
  # JOB 1: ANALYSE CODE
  # ===================================================================
  analyze:
    name: ðŸ“Š Code Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/math4child/package-lock.json
          
      - name: ðŸ“¦ Install dependencies
        run: |
          cd apps/math4child
          npm ci
          
      - name: ðŸ” TypeScript Check
        run: |
          cd apps/math4child
          npm run type-check
          
      - name: ðŸ” ESLint Analysis
        run: |
          cd apps/math4child
          npm run lint
          
      - name: ðŸ”’ Security Audit
        run: |
          cd apps/math4child
          npm audit --audit-level=moderate

  # ===================================================================
  # JOB 2: TESTS UNITAIRES
  # ===================================================================
  unit-tests:
    name: ðŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: analyze
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/math4child/package-lock.json
          
      - name: ðŸ“¦ Install dependencies
        run: |
          cd apps/math4child
          npm ci
          
      - name: ðŸ§ª Run Unit Tests
        run: |
          cd apps/math4child
          npm run test:ci
          
      - name: ðŸ“Š Upload Coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./apps/math4child/coverage/lcov.info
          fail_ci_if_error: false

  # ===================================================================
  # JOB 3: BUILD APPLICATION
  # ===================================================================
  build:
    name: ðŸ—ï¸ Build Application
    runs-on: ubuntu-latest
    needs: [analyze, unit-tests]
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/math4child/package-lock.json
          
      - name: ðŸ“¦ Install dependencies
        run: |
          cd apps/math4child
          npm ci
          
      - name: ðŸ—ï¸ Build Application
        run: |
          cd apps/math4child
          npm run build
          
      - name: ðŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-files
          path: apps/math4child/.next
          retention-days: 7

  # ===================================================================
  # JOB 4: TESTS E2E PLAYWRIGHT
  # ===================================================================
  e2e-tests:
    name: ðŸŽ­ E2E Tests
    runs-on: ubuntu-latest
    needs: build
    
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
        
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ“¦ Install App Dependencies
        run: |
          cd apps/math4child
          npm ci
          
      - name: ðŸ“¤ Download Build Artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-files
          path: apps/math4child/.next
          
      - name: ðŸŽ­ Install Playwright
        run: |
          cd tests
          npm ci
          npx playwright install --with-deps ${{ matrix.browser }}
          
      - name: ðŸš€ Start Application
        run: |
          cd apps/math4child
          npm start &
          sleep 10
        env:
          PORT: 3000
          
      - name: â³ Wait for App
        run: |
          timeout 60 bash -c 'until curl -s http://localhost:3000; do sleep 2; done'
          
      - name: ðŸŽ­ Run E2E Tests
        run: |
          cd tests
          npx playwright test --project=${{ matrix.browser }}-desktop
        env:
          BASE_URL: http://localhost:3000
          CI: true
          
      - name: ðŸ“¤ Upload Test Results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: playwright-report-${{ matrix.browser }}
          path: tests/playwright-report/
          retention-days: 30

  # ===================================================================
  # JOB 5: TESTS MULTILINGUES
  # ===================================================================
  i18n-tests:
    name: ðŸŒ Multilingual Tests
    runs-on: ubuntu-latest
    needs: build
    
    strategy:
      matrix:
        locale: [fr-FR, es-ES, de-DE, ar-SA, zh-CN]
        
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ“¦ Install Dependencies
        run: |
          cd apps/math4child && npm ci
          cd tests && npm ci
          
      - name: ðŸŽ­ Install Playwright
        run: |
          cd tests
          npx playwright install --with-deps chromium
          
      - name: ðŸ“¤ Download Build
        uses: actions/download-artifact@v3
        with:
          name: build-files
          path: apps/math4child/.next
          
      - name: ðŸš€ Start Application
        run: |
          cd apps/math4child
          npm start &
          sleep 10
          
      - name: ðŸŒ Run I18N Tests
        run: |
          cd tests
          npx playwright test --project=${{ matrix.locale }}-locale
        env:
          BASE_URL: http://localhost:3000
          TEST_LOCALE: ${{ matrix.locale }}
          CI: true
          
      - name: ðŸ“¤ Upload I18N Results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: i18n-report-${{ matrix.locale }}
          path: tests/playwright-report/

  # ===================================================================
  # JOB 6: TESTS PERFORMANCE
  # ===================================================================
  performance-tests:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ“¦ Install Dependencies
        run: |
          cd apps/math4child && npm ci
          cd tests && npm ci
          
      - name: ðŸ“¤ Download Build
        uses: actions/download-artifact@v3
        with:
          name: build-files
          path: apps/math4child/.next
          
      - name: ðŸš€ Start Application
        run: |
          cd apps/math4child
          npm start &
          sleep 10
          
      - name: âš¡ Run Lighthouse Audit
        run: |
          cd apps/math4child
          mkdir -p reports
          npm run lighthouse
          
      - name: âš¡ Run Performance Tests
        run: |
          cd tests
          npx playwright test --project=performance-chrome
        env:
          BASE_URL: http://localhost:3000
          PERF_TESTS: true
          
      - name: ðŸ“¤ Upload Performance Results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: performance-reports
          path: |
            apps/math4child/reports/
            tests/playwright-report/

  # ===================================================================
  # JOB 7: DÃ‰PLOIEMENT
  # ===================================================================
  deploy:
    name: ðŸš€ Deploy
    runs-on: ubuntu-latest
    needs: [e2e-tests, i18n-tests, performance-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    environment:
      name: production
      url: https://www.math4child.com
      
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¤ Download Build
        uses: actions/download-artifact@v3
        with:
          name: build-files
          path: apps/math4child/.next
          
      - name: ðŸš€ Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: apps/math4child
          vercel-args: '--prod'

  # ===================================================================
  # JOB 8: NOTIFICATIONS
  # ===================================================================
  notify:
    name: ðŸ“§ Notify Results
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    
    steps:
      - name: ðŸ“Š Generate Report
        run: |
          echo "# Math4Child Pipeline Results" > report.md
          echo "- **Commit:** ${{ github.sha }}" >> report.md
          echo "- **Branch:** ${{ github.ref }}" >> report.md
          echo "- **Status:** ${{ needs.deploy.result }}" >> report.md
          
      - name: ðŸ“§ Notify Slack
        uses: 8398a7/action-slack@v3
        if: always()
        with:
          status: ${{ job.status }}
          text: 'Math4Child Pipeline completed: ${{ job.status }}'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
